<!DOCTYPE html>
<html lang="en">

<head>
    <title>Kitchen Kompanion</title>
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="bootstrap.min.css">
    <script src="bootstrap.bundle.min.js"></script>

</head>

<body>
    <div class="device">
        <div id="Fridge Inventory" class="tabcontent" style="display:block;">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h1 class="m-0 fw-bold color-1">Inventory</h1>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addItemModal">
                            + Add Item
                        </button>
                    </div>
                    <hr class="hr-1">

                    <div id="inventoryList" class="d-flex flex-column gap-2">
                    </div>
                </div>
            </div>
        </div>

        <!--Add/change Item Modal-->
        <div class="modal fade" id="addItemModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addItemModalTitle">Add New Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addItemForm">
                            <div class="mb-3">
                                <label for="itemName" class="form-label">Item Name</label>
                                <input type="text" id="itemName" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="itemCategory" class="form-label">Category</label>
                                <input type="text" id="itemCategory" class="form-control"
                                    placeholder="Dairy, Produce, Meat...">
                            </div>
                            <div class="mb-3">
                                <label for="itemQuantity" class="form-label">Quantity</label>
                                <input type="text" id="itemQuantity" class="form-control"
                                    placeholder="1 gallon, 10 cups...">
                            </div>
                            <div class="mb-3">
                                <label for="itemDate" class="form-label">Expiration Date</label>
                                <input type="date" id="itemDate" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="addItemSubmitBtn">Add Item</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!--Remove Item Modal-->
        <div class="modal fade" id="deleteItemModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Remove Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="deleteMessage">Are you sure you want to remove this item?</p>
                        <p id="deleteExpiration" class="text-muted small mb-0"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn w-100 text-center btn-danger"
                            id="confirmDeleteBtn">Remove</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const form = document.getElementById('addItemForm');
            const list = document.getElementById('inventoryList');

            let itemToDelete = null;
            let itemToDeleteName = '';
            let itemToDeleteDate = '';

            let itemBeingEdited = null;
            let isEditing = false;

            const addItemModalEl = document.getElementById('addItemModal');

            addItemModalEl.addEventListener('hidden.bs.modal', () => {
                isEditing = false;
                itemBeingEdited = null;

                document.getElementById('addItemModalTitle').textContent = 'Add New Item';
                document.getElementById('addItemSubmitBtn').textContent = 'Add Item';

                form.reset();
            });

            form.addEventListener('submit', (e) => {
                e.preventDefault();

                const name = document.getElementById('itemName').value.trim();
                const category = document.getElementById('itemCategory').value.trim();
                const quantity = document.getElementById('itemQuantity').value.trim();
                const date = document.getElementById('itemDate').value;

                if (!name || !date) return;

                if (isEditing && itemBeingEdited) {
                    itemBeingEdited.dataset.name = name;
                    itemBeingEdited.dataset.date = date;
                    itemBeingEdited.dataset.category = category;
                    itemBeingEdited.dataset.quantity = quantity;

                    const formattedDate = formatMMDDYYYY(date);
                    const daysText = buildDaysText(date);
                    const niceCategory = category || 'Uncategorized';
                    const niceQuantity = quantity || '1';

                    itemBeingEdited.querySelector('.inv-name').textContent = name;
                    itemBeingEdited.querySelector('.inv-meta').textContent = `${niceCategory} Â· Quantity: ${niceQuantity}`;
                    itemBeingEdited.querySelector('.inv-days').textContent = daysText;
                    itemBeingEdited.querySelector('.inv-exp').textContent = `Expires ${formattedDate}`;

                    isEditing = false;
                    itemBeingEdited = null;
                    document.getElementById('addItemModalTitle').textContent = 'Add New Item';
                    document.getElementById('addItemSubmitBtn').textContent = 'Add Item';

                } else {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    itemDiv.style.height = '80px';

                    itemDiv.dataset.name = name;
                    itemDiv.dataset.date = date;
                    itemDiv.dataset.category = category;
                    itemDiv.dataset.quantity = quantity;

                    const formattedDate = formatMMDDYYYY(date);
                    const daysText = buildDaysText(date);
                    const niceCategory = category || 'Uncategorized';
                    const niceQuantity = quantity || '1';

                    itemDiv.innerHTML = `
                        <div class="inventory-item-content d-flex w-100 h-100 px-3 align-items-center">
                            <div class="flex-grow-1">
                            <div class="fw-semibold inv-name">${name}</div>
                            <div class="text-lightgray small inv-meta">${niceCategory} Â· Quantity: ${niceQuantity}</div>
                            </div>
                            <div class="text-end me-2">
                            <div class="fw-semibold inv-days">${daysText}</div>
                            <div class="text-lightgray small inv-exp">Expires ${formattedDate}</div>
                            </div>
                        </div>
                        <button class="inventory-delete-btn">&times;</button>
                        `;

                    list.appendChild(itemDiv);
                    addSwipeHandlers(itemDiv);

                    const delBtn = itemDiv.querySelector('.inventory-delete-btn');
                    delBtn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        itemToDelete = itemDiv;

                        const name = itemDiv.dataset.name || 'this item';
                        const date = itemDiv.dataset.date || '';
                        document.getElementById('deleteMessage').textContent = `Are you sure you want to remove ${name}?`;
                        document.getElementById('deleteExpiration').textContent = date ? buildExpirationText(date) : '';

                        const deleteModalEl = document.getElementById('deleteItemModal');
                        const deleteModal = bootstrap.Modal.getOrCreateInstance(deleteModalEl);
                        deleteModal.show();
                    });

                    itemDiv.addEventListener('click', (ev) => {
                        if (ev.target.closest('.inventory-delete-btn')) return;

                        if (itemDiv._justSwiped) {
                            itemDiv._justSwiped = false;
                            return;
                        }

                        openEditModalFor(itemDiv);
                    });
                }

                form.reset();
                const addModalEl = document.getElementById('addItemModal');
                const addModal = bootstrap.Modal.getOrCreateInstance(addModalEl);
                addModal.hide();
            });


            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                if (itemToDelete) {
                    itemToDelete.remove();
                }
                const deleteModalEl = document.getElementById('deleteItemModal');
                const deleteModal = bootstrap.Modal.getInstance(deleteModalEl);
                deleteModal.hide();
            });

            const deleteModalEl = document.getElementById('deleteItemModal');
            deleteModalEl.addEventListener('hide.bs.modal', () => {
                if (itemToDelete && itemToDelete.classList.contains('show-delete')) {
                    itemToDelete.classList.remove('show-delete');
                }
            });

            function buildExpirationText(isoDate) {
                const today = new Date();
                const itemDate = new Date(isoDate);
                const mm = String(itemDate.getMonth() + 1).padStart(2, '0');
                const dd = String(itemDate.getDate()).padStart(2, '0');
                const yyyy = itemDate.getFullYear();
                const formatted = `${mm}/${dd}/${yyyy}`;

                today.setHours(0, 0, 0, 0);
                itemDate.setHours(0, 0, 0, 0);

                if (itemDate < today) {
                    return `Expired on ${formatted}`;
                } else {
                    return `Expiration date: ${formatted}`;
                }
            }

            function formatMMDDYYYY(isoDate) {
                const [year, month, day] = isoDate.split("-");
                return `${month}/${day}/${year}`;
            }

            function buildDaysText(isoDate) {
                const today = new Date();
                const itemDate = new Date(isoDate);

                today.setHours(0, 0, 0, 0);
                itemDate.setHours(0, 0, 0, 0);

                const msPerDay = 1000 * 60 * 60 * 24;
                const diff = itemDate - today;
                const days = Math.round(diff / msPerDay);

                if (days < 0) {
                    return 'Expired';
                } else if (days === 0) {
                    return 'Use by End of Today';
                } else if (days === 1) {
                    return 'Use within 1 day';
                } else {
                    return `Use within ${days} days`;
                }
            }


            function openTab(tabName, element, color) {
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tabcontent");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }

                tablinks = document.getElementsByClassName("tablink");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].style.backgroundColor = "";
                }

                document.getElementById(tabName).style.display = "block";
                element.style.backgroundColor = color;
            }

            function addSwipeHandlers(item) {
                let startX = 0;
                let currentX = 0;
                let swiped = false;
                let isPointerDown = false;

                item._justSwiped = false;

                item.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    swiped = false;
                    item._justSwiped = false;
                });

                item.addEventListener('touchmove', (e) => {
                    currentX = e.touches[0].clientX;
                    const diff = currentX - startX;

                    if (diff < -30 && !swiped) {
                        item.classList.add('show-delete');
                        swiped = true;
                        item._justSwiped = true;
                    }
                    if (diff > 30 && item.classList.contains('show-delete')) {
                        item.classList.remove('show-delete');
                        item._justSwiped = true;
                    }
                });

                item.addEventListener('mousedown', (e) => {
                    startX = e.clientX;
                    swiped = false;
                    isPointerDown = true;
                    item._justSwiped = false;
                });

                item.addEventListener('mousemove', (e) => {
                    if (!isPointerDown) return;
                    currentX = e.clientX;
                    const diff = currentX - startX;

                    if (diff < -30 && !swiped) {
                        item.classList.add('show-delete');
                        swiped = true;
                        item._justSwiped = true;
                    }
                    if (diff > 30 && item.classList.contains('show-delete')) {
                        item.classList.remove('show-delete');
                        item._justSwiped = true;
                    }
                });

                item.addEventListener('mouseup', () => {
                    isPointerDown = false;
                });

                item.addEventListener('mouseleave', () => {
                    isPointerDown = false;
                });
            }


            function openEditModalFor(itemDiv) {
                isEditing = true;
                itemBeingEdited = itemDiv;

                document.getElementById('itemName').value = itemDiv.dataset.name || '';
                document.getElementById('itemDate').value = itemDiv.dataset.date || '';
                document.getElementById('itemCategory').value = itemDiv.dataset.category || '';
                document.getElementById('itemQuantity').value = itemDiv.dataset.quantity || '';

                document.getElementById('addItemModalTitle').textContent = 'Edit Item';
                document.getElementById('addItemSubmitBtn').textContent = 'Update Item';

                const addModal = new bootstrap.Modal(document.getElementById('addItemModal'));
                addModal.show();
            }
            document.getElementById("defaultOpen").click();
        </script>

        <div id="Shopping List" class="tabcontent" style="display:none;">
        </div>

        <div id="Recipes" class="tabcontent" style="display:none;">
        </div>

        <div class="tab-navigation">
            <button id="defaultOpen" class="tablink" onclick="openTab('Fridge Inventory', this, '#ffb6c1')">
                <div class="tab-icon">ðŸ‘¤</div>
                <div class="tab-label">Fridge Inventory</div>
            </button>
            <button class="tablink" onclick="openTab('Shopping List', this, '#ffb6c1')">
                <div class="tab-icon">ðŸ’¡</div>
                <div class="tab-label">Shopping List</div>
            </button>
            <button class="tablink" onclick="openTab('Recipes', this, '#ffb6c1')">
                <div class="tab-icon">âœ…</div>
                <div class="tab-label">Recipes</div>
            </button>
        </div>
    </div>

    <script>
        function openTab(tabName, element, color) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tablinks = document.getElementsByClassName("tablink");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].style.backgroundColor = "";
            }

            document.getElementById(tabName).style.display = "block";

            element.style.backgroundColor = color;
        }

        document.getElementById("defaultOpen").click();
    </script>
</body>

</html>